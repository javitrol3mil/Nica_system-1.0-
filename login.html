<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Login — Nica System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    /* RUTAS DE IMAGEN que podés cambiar */
    --bg-image: url("/nicasystem/static/Fondo.jpg");   /* fondo pantalla */
    --hero-image: url('/nicasystem/static/Fondo.jpg'); /* imagen debajo del título */
    --tint: rgba(24,15,51,.55);  /* velo encima del fondo */
    --panel: rgba(255,255,255,.92);
    --accent: #6d28d9;
    --accent-2: #a855f7;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
    background: var(--tint), var(--bg-image) center/cover no-repeat fixed;
    font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
    color:#1f2430;
  }
  .card{
    width: min(92vw, 420px);
    background: var(--panel);
    border-radius: 18px;
    box-shadow: 0 20px 50px rgba(0,0,0,.35);
    overflow: hidden;
  }
  .hero{
    height: 180px;
    background: var(--hero-image) center/cover no-repeat;
    position: relative;
  }
  .hero h1{
    position:absolute; left:0; right:0; bottom:10px; text-align:center;
    color:white; text-shadow:0 3px 10px rgba(0,0,0,.6);
    font-size: 34px; letter-spacing:1px; margin:0;
  }
  .tabs{ display:flex; gap:20px; justify-content:center; margin:12px 0 6px; font-weight:800 }
  .tabs button{ background:transparent; border:0; padding:8px 6px; cursor:pointer; font-size:18px }
  .tabs .active{ color:var(--accent) }
  .panel{ padding:16px 18px 20px }
  input{ width:100%; padding:12px; margin:6px 0 10px; border-radius:12px; border:1px solid #e6e8ef; background:#fff }
  button{ width:100%; padding:12px; border:0; border-radius:12px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; font-weight:700; cursor:pointer }
  .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin:2px 0 10px }
  .hint{ text-align:center; margin-top:10px; color:#6b7280 }
  .err{ color:#ef4444 } .ok{ color:#16a34a }
</style>
</head>
<body>
  <div class="card">
    <div class="hero">
      <h1>Nica System <span style="font-weight:300"></span></h1>
    </div>
    <div class="panel">
      <div class="tabs">
        <button id="tabLogin" class="active">Login</button>
        <button id="tabReg">Register</button>
      </div>

      <div id="viewLogin">
        <input id="l_email" type="email" placeholder="Email" required>
        <input id="l_pass" type="password" placeholder="Password" required>
        <div class="row">
          <label><input type="checkbox"> remember me</label>
          <a href="#" style="color:#6b7280;text-decoration:none">forgot password</a>
        </div>
        <button id="btnLogin">Login</button>
        <p id="l_msg"></p>
        <p class="hint">Create Account → <a href="#" id="goReg">Register</a></p>
      </div>

      <div id="viewReg" style="display:none">
        <input id="r_nombre" placeholder="Nombre" required>
        <input id="r_email" type="email" placeholder="Email" required>
        <input id="r_pass" type="password" placeholder="Password" required>
        <button id="btnReg">Crear cuenta</button>
        <p id="r_msg"></p>
        <p class="hint"><a href="#" id="goLogin">Volver a Login</a></p>
      </div>
    </div>
  </div>

<script>
const API = window.location.origin;
const setToken = t => localStorage.setItem("token", t);

function swap(to){
  document.getElementById("viewLogin").style.display = (to==="login"?"block":"none");
  document.getElementById("viewReg").style.display   = (to==="reg"  ?"block":"none");
  document.getElementById("tabLogin").classList.toggle("active", to==="login");
  document.getElementById("tabReg").classList.toggle("active", to==="reg");
}

document.getElementById("tabLogin").onclick = ()=>swap("login");
document.getElementById("tabReg").onclick   = ()=>swap("reg");
document.getElementById("goReg").onclick    = (e)=>{e.preventDefault();swap("reg");}
document.getElementById("goLogin").onclick  = (e)=>{e.preventDefault();swap("login");}

// === LOGIN ===
document.getElementById("btnLogin").onclick = async ()=>{
  const msg = document.getElementById("l_msg");
  msg.textContent = "";
  try{
    const r=await fetch(`${API}/auth/login`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      credentials:"include",
      body:JSON.stringify({
        email:document.getElementById("l_email").value,
        password:document.getElementById("l_pass").value
      })
    });
    const body=await r.json();
    if(r.status===401) throw new Error("Credenciales inválidas.");
    if(!r.ok) throw new Error(body.detail||"Error en el inicio de sesión.");

    // Guardar nombre/email/avatar (preferir backend)
    const nombreOK = body.nombre ?? "";
    const emailOK  = body.email  ?? "";
    const avatarOK = body.avatar ?? "/static/Iconos/usuario.png";

    localStorage.setItem("nombre", nombreOK);
    localStorage.setItem("email",  emailOK);
    if (!localStorage.getItem("avatar")) localStorage.setItem("avatar", avatarOK);
    if (body.id)  localStorage.setItem("uid",  body.id);
    if (body.rol) localStorage.setItem("rol",  body.rol);

    // Redirección limpia
    window.location.replace("/app");
  }catch(err){
    msg.textContent=err.message;
    msg.className="err";
  }
};

// === REGISTRO ===
document.getElementById("btnReg").onclick = async ()=>{
  const msg = document.getElementById("r_msg"); 
  msg.textContent = "";

  try{
    const nombre   = document.getElementById("r_nombre").value.trim();
    const email    = document.getElementById("r_email").value.trim();
    const password = document.getElementById("r_pass").value;

    const r = await fetch(`${API}/auth/register`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ nombre, email, password }),
      credentials: "include"
    });
    const body = await r.json();

    if (r.status === 409) throw new Error("Ese correo ya está registrado.");
    if(!r.ok) throw new Error(body.detail || "No se pudo crear la cuenta.");

    // Preferir datos del backend si vienen
    const nombreOK = body.nombre ?? nombre;
    const emailOK  = body.email  ?? email;
    const avatarOK = body.avatar ?? "/static/Iconos/usuario.png";

    // No borrar preferencias: solo limpiar claves de sesión
    const keepTema = localStorage.getItem("tema");
    ["nombre","email","avatar","uid","rol","token"].forEach(k=>localStorage.removeItem(k));
    if (keepTema) localStorage.setItem("tema", keepTema);

    // Guardar nueva sesión
    localStorage.setItem("nombre", nombreOK);
    localStorage.setItem("email",  emailOK);
    if (!localStorage.getItem("avatar")) localStorage.setItem("avatar", avatarOK);
    if (body.id)  localStorage.setItem("uid",  body.id);
    if (body.rol) localStorage.setItem("rol",  body.rol);

    msg.textContent = "Usuario creado. Redirigiendo...";
    msg.className   = "ok";
    setTimeout(()=>{ window.location.replace("/app"); }, 250);
  }catch(err){
    msg.textContent = err.message;
    msg.className   = "err";
  }
};
</script>
</body>
</html>
